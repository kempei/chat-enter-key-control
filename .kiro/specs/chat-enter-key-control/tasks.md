# 実装計画

- [x] 1. プロジェクト構造とマニフェストの作成
  - Chrome拡張機能のディレクトリ構造を作成
  - manifest.jsonを作成（Manifest V3形式）
  - 基本的なアイコンファイルを配置
  - _要件: 3.5, 8.1, 8.2_

- [x] 2. ストレージ管理モジュールの実装
  - URLパターンの保存・読み込み機能を実装
  - Chrome Storage APIのラッパー関数を作成
  - _要件: 3.2, 6.1, 6.2, 6.3_

- [x] 2.1 ストレージ操作のプロパティテストを実装
  - **プロパティ 4: URLパターンのラウンドトリップ**
  - **検証対象: 要件 3.2, 6.1, 6.2**

- [x] 2.2 パターン削除のプロパティテストを実装
  - **プロパティ 5: URLパターンの削除は状態を変更する**
  - **検証対象: 要件 3.3**

- [x] 2.3 パターントグルのプロパティテストを実装
  - **プロパティ 6: URLパターンのトグルは状態を反転する**
  - **検証対象: 要件 3.4**

- [x] 2.4 設定永続化のプロパティテストを実装
  - **プロパティ 13: 設定変更は即座に永続化される**
  - **検証対象: 要件 6.3**

- [x] 2.5 設定エクスポートのプロパティテストを実装
  - **プロパティ 14: 設定のエクスポートはすべてのパターンを含む**
  - **検証対象: 要件 6.5**

- [x] 3. URLパターンマッチング機能の実装
  - Chrome match patternを正規表現に変換する関数を実装
  - URLとパターンのマッチング判定関数を実装
  - _要件: 3.5_

- [x] 3.1 URLマッチングのプロパティテストを実装
  - **プロパティ 7: マッチするURLパターンでスクリプトが注入される**
  - **検証対象: 要件 3.5**

- [x] 4. Background Scriptの実装
  - メッセージハンドラを実装（GET_PATTERNS, ADD_PATTERN, REMOVE_PATTERN, TOGGLE_PATTERN）
  - アクティブタブのURL確認機能を実装
  - 拡張機能アイコンの状態更新機能を実装
  - _要件: 3.2, 3.3, 3.4, 8.1, 8.2_

- [x] 4.1 アイコン状態のプロパティテストを実装
  - **プロパティ 16: アクティブ状態に応じたアイコン表示**
  - **検証対象: 要件 8.1, 8.2**

- [x] 5. テキストフィールド検出機能の実装
  - textarea、input[type="text"]、contenteditable要素を検出する関数を実装
  - MutationObserverで動的に追加される要素を監視
  - フィールドレジストリ（Map）を実装
  - _要件: 4.1, 4.2, 4.4, 4.5_

- [x] 5.1 フィールド検出のプロパティテストを実装
  - **プロパティ 8: すべてのテキスト入力フィールドが検出される**
  - **検証対象: 要件 4.1, 4.4, 4.5**

- [x] 6. キーボードイベントハンドラの実装
  - keydownイベントリスナーを実装
  - Enterキーと修飾キーの判定ロジックを実装
  - isComposingプロパティでIME状態を判定
  - イベントの伝播制御（preventDefault、stopPropagation、stopImmediatePropagation）
  - _要件: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 5.3, 5.4_

- [x] 6.1 IME入力中のEnter処理のプロパティテストを実装
  - **プロパティ 1: IME入力中のEnter単独押下は送信を防止する**
  - **検証対象: 要件 1.1, 1.2, 1.3**

- [x] 6.2 通常のEnter処理のプロパティテストを実装
  - **プロパティ 2: 通常のEnter押下は改行を挿入する**
  - **検証対象: 要件 1.4**

- [x] 6.3 修飾キー+Enter処理のプロパティテストを実装
  - **プロパティ 3: 修飾キー+Enterは送信アクションを発火する**
  - **検証対象: 要件 2.1, 2.2, 2.3, 2.4, 2.5**

- [x] 6.4 イベント伝播制御のプロパティテストを実装
  - **プロパティ 11: 修飾キーなしのEnterイベントは伝播しない**
  - **検証対象: 要件 5.3**

- [x] 6.5 修飾キー付きイベント伝播のプロパティテストを実装
  - **プロパティ 12: 修飾キー付きイベントは伝播する**
  - **検証対象: 要件 5.4**

- [x] 7. 改行挿入機能の実装
  - textarea/input要素への改行挿入関数を実装
  - contenteditable要素への改行挿入（execCommand）を実装
  - カーソル位置の保持
  - _要件: 1.2, 1.4_

- [x] 8. Content Scriptの統合
  - フィールド検出とイベントハンドラを統合
  - ページロード時の初期化処理を実装
  - イベントリスナーのクリーンアップ処理を実装
  - _要件: 4.3, 7.4_

- [x] 8.1 フィールドクリーンアップのプロパティテストを実装
  - **プロパティ 9: フィールド削除時にリスナーがクリーンアップされる**
  - **検証対象: 要件 4.3**

- [x] 8.2 タブ独立性のプロパティテストを実装
  - **プロパティ 15: タブ間の状態は独立している**
  - **検証対象: 要件 7.4**

- [x] 9. 送信ボタンとの互換性確保
  - 送信ボタンのクリックイベントが妨げられないことを確認
  - 既存のアプリケーションロジックとの共存を確認
  - _要件: 5.1, 5.2_

- [x] 9.1 送信ボタン互換性のプロパティテストを実装
  - **プロパティ 10: 送信ボタンのクリックは妨げられない**
  - **検証対象: 要件 5.1**

- [x] 10. Popup UIの実装
  - popup.htmlとCSSを作成
  - URLパターンリストの表示機能を実装
  - パターンの追加・削除・トグルUIを実装
  - 現在のページのマッチング状態表示を実装
  - 現在のドメインの簡易トグル機能を実装
  - _要件: 3.1, 3.2, 3.3, 3.4, 8.3, 8.4, 8.5_

- [x] 10.1 ポップアップ表示のプロパティテストを実装
  - **プロパティ 17: ポップアップは現在のページ状態を表示する**
  - **検証対象: 要件 8.3, 8.4**

- [x] 10.2 ドメイントグルのプロパティテストを実装
  - **プロパティ 18: ポップアップからドメインをトグルできる**
  - **検証対象: 要件 8.5**

- [x] 11. エラーハンドリングの実装
  - ストレージエラーのハンドリングとユーザーへの通知
  - DOM操作エラーのハンドリング
  - イベント処理エラーのハンドリング
  - URLパターン検証とエラーメッセージ
  - _要件: 6.4_

- [x] 12. 設定のインポート/エクスポート機能の実装
  - 設定をJSONファイルとしてエクスポート
  - JSONファイルから設定をインポート
  - _要件: 6.5_

- [x] 13. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [x] 14. 実際のチャットアプリケーションでの統合テスト
  - ChatGPT、Slack、Discordなどの実際のサイトで動作確認
  - 日本語入力での動作確認
  - 複数タブでの動作確認
  - _要件: すべて_

- [x] 15. パフォーマンステスト
  - 初期化時間が100ms以内であることを確認
  - イベント処理時間が10ms以内であることを確認
  - 多数のフィールド（100個）でのパフォーマンス確認
  - _要件: 7.1, 7.3, 7.5_

- [x] 16. ドキュメントの作成
  - README.mdを作成（インストール方法、使用方法）
  - 対応サイトのリストを作成
  - トラブルシューティングガイドを作成

- [x] 17. 送信キー設定のストレージ管理を実装
  - SendKeyConfigのデータ型を定義
  - 送信キー設定の保存・読み込み機能を実装
  - デフォルト値（Cmd+Enter）の処理を実装
  - _要件: 9.7, 9.8, 9.9_

- [x] 17.1 送信キー設定のラウンドトリップテストを実装
  - **プロパティ 20: 送信キー設定のラウンドトリップ**
  - **検証対象: 要件 9.7, 9.8**

- [x] 18. Background Scriptに送信キー設定のメッセージハンドラを追加
  - GET_SEND_KEY_CONFIGメッセージハンドラを実装
  - SET_SEND_KEY_CONFIGメッセージハンドラを実装
  - Content Scriptへの設定配信機能を実装
  - _要件: 9.2, 9.7_

- [x] 19. Content Scriptのキーボードイベントハンドラを更新
  - 送信キー設定を取得する機能を実装
  - 設定された送信キーと一致するかチェックする関数を実装
  - handleKeyDownメソッドを更新して送信キー設定に対応
  - IME入力中は送信キーが押されても送信を防止
  - _要件: 2.1, 2.2, 9.3, 9.4, 9.6_

- [x] 19.1 設定された送信キーのプロパティテストを実装
  - **プロパティ 3: 設定された送信キーは送信アクションを発火する**
  - **検証対象: 要件 2.1, 9.3**

- [x] 19.2 設定と異なる修飾キーのプロパティテストを実装
  - **プロパティ 19: 設定と異なる修飾キーは改行を挿入する**
  - **検証対象: 要件 2.2, 9.4**

- [x] 19.3 Enterのみ設定時のIME保護プロパティテストを実装
  - **プロパティ 21: Enterのみ設定時のIME保護**
  - **検証対象: 要件 9.6**

- [x] 20. Popup UIに送信キー設定UIを追加
  - 送信キー選択のドロップダウンを実装
  - 現在の送信キー設定を表示
  - 送信キー変更時の保存処理を実装
  - _要件: 9.1, 9.2_

- [x] 21. チェックポイント - 送信キーカスタマイズ機能のテスト
  - すべてのテストが通ることを確認し、問題があればユーザーに質問する

- [ ] 22. 実際のチャットアプリケーションで送信キーカスタマイズ機能をテスト
  - 各送信キーオプション（Ctrl+Enter、Alt+Enter、Cmd+Enter、Opt+Enter、Shift+Enter、Enter）で動作確認
  - IME入力中の動作確認
  - 設定の永続化確認
  - _要件: 9.3, 9.4, 9.5, 9.6_

- [x] 23. ドキュメントを更新
  - README.mdに送信キーカスタマイズ機能の説明を追加
  - 各送信キーオプションの説明を追加
  - _要件: 9.1_

- [x] 24. 送信キー選択UIをラジオボタンからドロップダウンに変更
  - popup.htmlの送信キー選択UIをラジオボタンから`<select>`要素に変更
  - popup.jsの送信キー設定の読み込み・保存ロジックをドロップダウンに対応
  - popup.cssのスタイルをドロップダウンに合わせて調整
  - UIのコンパクト化を実現
  - _要件: 9.1_
