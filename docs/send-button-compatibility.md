# 送信ボタンとの互換性

## 概要

Chat Enter Key Control拡張機能は、送信ボタンのクリックイベントを妨げず、既存のアプリケーションロジックと共存できるように設計されています。

## 実装の詳細

### 要件5.1: 送信ボタンのクリックイベント

送信ボタンのクリックイベントは、キーボードイベントとは独立したイベントストリームです。本拡張機能は`keydown`イベントのみを処理するため、`click`イベントには一切干渉しません。

**動作:**
- 送信ボタンをクリック → 正常に送信イベントが発火
- Enterキー押下後に送信ボタンをクリック → 正常に送信イベントが発火

### 要件5.2: 既存のアプリケーションロジックとの共存

本拡張機能は、修飾キーの有無によってイベントの伝播を制御します。

#### 修飾キーなしのEnterキー

```javascript
// 修飾キーなし: 送信を防止、改行を挿入
event.preventDefault();
event.stopPropagation();
event.stopImmediatePropagation();
```

- `preventDefault()`: デフォルトの動作（フォーム送信など）を防止
- `stopPropagation()`: イベントの伝播を停止
- `stopImmediatePropagation()`: 同じ要素の他のリスナーへの伝播も停止

**結果:** アプリケーションのEnterキーリスナーは呼ばれず、誤送信が防止されます。

#### 修飾キー付きのEnterキー

```javascript
// 修飾キーあり: 元の送信動作を許可
// 何もしない（デフォルトの動作を許可し、イベントを伝播させる）
```

**結果:** アプリケーションのEnterキーリスナーが正常に呼ばれ、送信処理が実行されます。

## テスト結果

### ユニットテスト

以下のシナリオをテストしました：

1. ✅ 送信ボタンのクリックイベントは妨げられない
2. ✅ Enterキーイベント処理中でも送信ボタンは機能する
3. ✅ 修飾キーなしのEnterキーはアプリケーションのリスナーに伝播しない
4. ✅ 修飾キー付きのEnterキーはアプリケーションのリスナーに伝播する
5. ✅ カスタムJavaScriptによる送信処理は妨げられない
6. ✅ 修飾キー付きEnterでアプリケーションの送信ロジックが実行される

### E2Eテスト

実際のブラウザ環境で以下のシナリオをテストしました：

1. ✅ textareaの送信ボタンクリックは妨げられない
2. ✅ inputの送信ボタンクリックは妨げられない
3. ✅ contenteditableの送信ボタンクリックは妨げられない
4. ✅ Enterキー後でも送信ボタンは機能する
5. ✅ 修飾キー+Enterでアプリケーションのリスナーが呼ばれる
6. ✅ 修飾キーなしのEnterでアプリケーションのリスナーは呼ばれない

## 互換性の保証

本拡張機能は以下の方法で既存のアプリケーションとの互換性を保証します：

1. **イベントの選択的処理**: `keydown`イベントのみを処理し、`click`イベントには干渉しない
2. **修飾キーの尊重**: 修飾キー付きのEnterキーは通常通り伝播させる
3. **useCapture=true**: 早期にイベントをキャッチして、必要に応じてブロック
4. **stopImmediatePropagation**: 同じ要素の他のリスナーへの伝播も確実にブロック

## 対応するチャットアプリケーション

以下のようなチャットアプリケーションで正常に動作します：

- **送信ボタンベース**: 送信ボタンのクリックで送信するアプリケーション
- **Enterキーベース**: Enterキーで送信するアプリケーション
- **修飾キー+Enterベース**: Ctrl+EnterやCmd+Enterで送信するアプリケーション
- **ハイブリッド**: 送信ボタンとEnterキーの両方をサポートするアプリケーション

## 実装ファイル

- `content.js`: キーボードイベントハンドリングの実装
- `test/send-button-compatibility.test.js`: ユニットテスト
- `test/e2e/send-button.e2e.test.js`: E2Eテスト
- `test/e2e/test-page.html`: テストページ（送信ボタン付き）

## 参考

- 要件定義: `.kiro/specs/chat-enter-key-control/requirements.md` - 要件5.1, 5.2
- 設計書: `.kiro/specs/chat-enter-key-control/design.md` - プロパティ10, 11, 12
